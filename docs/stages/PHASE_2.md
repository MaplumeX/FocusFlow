# Phase 2: 会话管理 - 阶段任务文档

**阶段代号:** Phase 2
**阶段名称:** 会话管理（Focus Session Management）
**开始日期:** 2025-12-16
**结束日期:** 2025-12-20
**工期:** 1 周（5 个工作日）
**里程碑:** M2 - 会话管理完成
**状态:** 🔴 等待 Phase 1 完成

---

## 📋 目录

1. [阶段目标](#1-阶段目标)
2. [核心交付物](#2-核心交付物)
3. [任务列表](#3-任务列表)
4. [依赖关系](#4-依赖关系)
5. [验收标准](#5-验收标准)
6. [红线检查](#6-红线检查)
7. [规范检查](#7-规范检查)
8. [风险与应对](#8-风险与应对)

---

## 1. 阶段目标

### 1.1 核心目标

**实现完整的专注会话生命周期**

具体目标：
- ✅ 实现会话数据模型（focus_sessions、pomodoro_records 表）
- ✅ 实现多番茄钟连续执行
- ✅ 实现自动休息提醒（短休息/长休息）
- ✅ 实现会话统计（本次会话、今日总计）
- ✅ 实现跳过休息功能

### 1.2 成功标准

**功能性：**
- 完成一个工作时段后自动进入休息
- 完成 N 个番茄钟后自动进入长休息
- 休息结束后提示用户继续
- 用户可以跳过休息直接开始工作
- 会话数据完整记录到数据库

**技术性：**
- 会话状态机逻辑正确
- 配置快照保存（修改配置不影响当前会话）
- 无内存泄漏（定时器正确清理）
- 数据库操作正确（使用参数化查询）

---

## 2. 核心交付物

### 2.1 交付物清单

| # | 交付物名称 | 类型 | 优先级 | 负责人 | 状态 |
|---|-----------|------|--------|--------|------|
| 1 | 会话数据模型 | SQL | P0 | 开发 | 🔴 等待 M1 |
| 2 | 会话管理模块 | 代码 | P0 | 开发 | 🔴 等待 M1 |
| 3 | 状态机实现 | 代码 | P0 | 开发 | 🔴 等待 M1 |
| 4 | 自动休息功能 | 代码 | P0 | 开发 | 🔴 等待 M1 |
| 5 | 休息提示组件 | 代码 | P0 | 开发 | 🔴 等待 M1 |
| 6 | 会话统计功能 | 代码 | P0 | 开发 | 🔴 等待 M1 |
| 7 | 跳过休息功能 | 代码 | P1 | 开发 | 🔴 等待 M1 |
| 8 | 会话流程文档 | 文档 | P1 | 开发 | 🔴 等待 M1 |

### 2.2 交付物详细说明

#### D1: 会话数据模型
- **内容：** 扩展数据库 Schema
- **包含：** focus_sessions、pomodoro_records 表
- **验收：** 表结构正确，支持配置快照

#### D2: 会话管理模块
- **内容：** 会话 CRUD 操作
- **包含：** 创建会话、结束会话、记录番茄钟
- **验收：** 数据库操作正确

#### D3: 状态机实现
- **内容：** 会话状态转换逻辑
- **包含：** work → short_break → work → long_break
- **验收：** 状态转换正确

#### D4: 自动休息功能
- **内容：** 工作结束后自动进入休息
- **包含：** 判断休息类型、启动休息计时器
- **验收：** 自动休息逻辑正确

#### D5: 休息提示组件
- **内容：** 休息结束后的提示界面
- **包含：** 提示信息、继续按钮
- **验收：** UI 清晰，操作流畅

#### D6: 会话统计功能
- **内容：** 统计本次会话和今日数据
- **包含：** 番茄钟计数、时长统计
- **验收：** 统计准确

#### D7: 跳过休息功能
- **内容：** 允许用户跳过休息
- **包含：** 跳过按钮、状态处理
- **验收：** 功能正常，不影响统计

#### D8: 会话流程文档
- **内容：** 会话流程说明文档
- **包含：** 状态图、数据流图
- **验收：** 清晰易懂

---

## 3. 任务列表

### 3.1 Day 1: 数据模型扩展（2025-12-16）

**任务 ID: P2-D1-T1**
```
任务：扩展数据库 Schema
负责人：开发
预估时间：2h
优先级：P0

步骤：
□ 创建 focus_sessions 表
□ 创建 pomodoro_records 表
□ 添加索引优化
□ 编写数据库迁移脚本（可选）

产出：
- 更新 database/schema.sql
- 数据库迁移脚本（可选）

验收：
✓ 表结构符合 PRD 定义
✓ 支持配置快照
✓ 外键约束正确
✓ 索引创建正确
```

**任务 ID: P2-D1-T2**
```
任务：实现会话数据库操作
负责人：开发
预估时间：3h
优先级：P0

步骤：
□ 实现 createSession()
□ 实现 endSession()
□ 实现 getActiveSession()
□ 实现 createPomodoroRecord()
□ 实现 updatePomodoroRecord()

产出：
- 扩展 main/database.js

验收：
✓ 所有操作使用参数化查询
✓ 错误处理完整
✓ 配置快照正确保存
```

**任务 ID: P2-D1-T3**
```
任务：实现会话 IPC API
负责人：开发
预估时间：2h
优先级：P0

步骤：
□ 在 preload.js 中暴露会话 API
□ 在 ipc.js 中注册处理器
□ 测试 IPC 调用

产出：
- 扩展 preload/index.js
- 扩展 main/ipc.js

验收：
✓ 会话 API 可正常调用
✓ 数据传递正确
```

---

### 3.2 Day 2: 状态机实现（2025-12-17）

**任务 ID: P2-D2-T1**
```
任务：设计会话状态机
负责人：开发
预估时间：2h
优先级：P0

步骤：
□ 定义状态枚举（work, short_break, long_break, idle）
□ 定义状态转换规则
□ 绘制状态转换图（可选）

产出：
- 状态机设计文档
- 状态转换图（可选）

验收：
✓ 状态定义清晰
✓ 转换规则正确
```

**任务 ID: P2-D2-T2**
```
任务：实现 useSessionStore
负责人：开发
预估时间：4h
优先级：P0

步骤：
□ 创建 store/useSessionStore.js
□ 定义会话状态
□ 实现 startSession()
□ 实现 endSession()
□ 实现状态转换逻辑
□ 实现 onPomodoroComplete()

产出：
- store/useSessionStore.js

验收：
✓ 使用 Zustand
✓ 状态转换正确
✓ 与 useTimerStore 集成
```

**任务 ID: P2-D2-T3**
```
任务：集成状态机到计时器
负责人：开发
预估时间：2h
优先级：P0

步骤：
□ 修改 useTimerStore
□ 集成 useSessionStore
□ 实现番茄钟完成回调

产出：
- 更新 store/useTimerStore.js

验收：
✓ 计时器结束时触发状态转换
✓ 会话数据正确记录
```

---

### 3.3 Day 3: 自动休息功能（2025-12-18）

**任务 ID: P2-D3-T1**
```
任务：实现休息类型判断
负责人：开发
预估时间：2h
优先级：P0

步骤：
□ 根据番茄钟计数判断休息类型
□ 实现长休息间隔逻辑
□ 单元测试（可选）

产出：
- utils/sessionUtils.js

验收：
✓ 休息类型判断正确
✓ 长休息间隔准确
```

**任务 ID: P2-D3-T2**
```
任务：实现自动进入休息
负责人：开发
预估时间：3h
优先级：P0

步骤：
□ 工作结束时自动启动休息计时器
□ 应用休息时长配置
□ 显示系统通知
□ 更新 UI 状态

产出：
- 扩展 useSessionStore.js
- 扩展 Home.jsx

验收：
✓ 自动进入休息
✓ 通知显示正确
✓ UI 状态更新
```

**任务 ID: P2-D3-T3**
```
任务：实现休息结束提示
负责人：开发
预估时间：2h
优先级：P0

步骤：
□ 创建 BreakEndModal 组件
□ 显示"休息结束，继续工作？"
□ 提供"继续"按钮

产出：
- components/BreakEndModal.jsx
- components/BreakEndModal.module.css

验收：
✓ 模态框显示正确
✓ 点击继续后开始新番茄钟
```

---

### 3.4 Day 4: 会话统计和跳过功能（2025-12-19）

**任务 ID: P2-D4-T1**
```
任务：实现会话统计
负责人：开发
预估时间：3h
优先级：P0

步骤：
□ 实现本次会话统计（番茄钟数、时长）
□ 实现今日统计
□ 在 UI 中显示统计数据

产出：
- utils/sessionStats.js
- 扩展 Home.jsx

验收：
✓ 统计数据准确
✓ UI 显示清晰
```

**任务 ID: P2-D4-T2**
```
任务：实现跳过休息功能
负责人：开发
预估时间：2h
优先级：P1

步骤：
□ 添加"跳过休息"按钮
□ 实现跳过逻辑（直接进入下一个工作时段）
□ 更新会话数据

产出：
- 扩展 Home.jsx
- 扩展 useSessionStore.js

验收：
✓ 跳过功能正常
✓ 会话数据正确
```

**任务 ID: P2-D4-T3**
```
任务：实现会话暂停和恢复
负责人：开发
预估时间：2h
优先级：P1

步骤：
□ 支持会话级别的暂停
□ 记录暂停时间点
□ 恢复时继续当前番茄钟

产出：
- 扩展 useSessionStore.js

验收：
✓ 暂停/恢复正确
✓ 时间计算准确
```

---

### 3.5 Day 5: 测试和优化（2025-12-20）

**任务 ID: P2-D5-T1**
```
任务：完整流程测试
负责人：开发
预估时间：3h
优先级：P0

步骤：
□ 测试完整的番茄钟流程
  - 开始工作 → 自动休息 → 继续工作 → 长休息
□ 测试跳过休息
□ 测试暂停/恢复
□ 测试会话数据记录
□ 测试统计准确性

产出：
- 测试报告
- Bug 列表

验收：
✓ 完整流程无误
✓ 会话数据正确
✓ 统计准确
```

**任务 ID: P2-D5-T2**
```
任务：边界情况测试
负责人：开发
预估时间：2h
优先级：P0

步骤：
□ 测试中途停止会话
□ 测试应用关闭时的会话保存
□ 测试配置修改对当前会话的影响
□ 测试内存泄漏

产出：
- 边界测试报告

验收：
✓ 边界情况处理正确
✓ 无内存泄漏
```

**任务 ID: P2-D5-T3**
```
任务：代码优化和文档
负责人：开发
预估时间：2h
优先级：P1

步骤：
□ 代码审查和重构
□ 清理 console.log
□ 编写会话流程文档
□ 更新 README.md

产出：
- 会话流程文档
- 优化后的代码

验收：
✓ 代码质量高
✓ 文档清晰
```

---

## 4. 依赖关系

### 4.1 任务依赖图

```
Day 1: 数据模型
  └─> Day 2: 状态机
       └─> Day 3: 自动休息
            └─> Day 4: 统计和跳过
                 └─> Day 5: 测试优化
```

### 4.2 关键路径

```
关键路径（5 天）:
Day 1 → Day 2 → Day 3 → Day 4 → Day 5

并行任务：
- Day 4: 统计和跳过功能可部分并行
```

### 4.3 前置条件

```
☑️ Phase 1 完成
  - 专注事项管理 ✓
  - 基础计时器 ✓
  - 本地数据库 ✓
  - 系统通知 ✓

☑️ M1 验收通过
  - 所有 P0 任务完成
  - 核心功能正常
```

---

## 5. 验收标准

### 5.1 功能性验收

#### 会话创建和管理
```
□ 点击"开始专注"时创建新会话
  - 保存当前事项的配置快照
  - 记录会话开始时间
  - 设置会话为活动状态

□ 会话结束时正确保存
  - 记录会话结束时间
  - 更新专注事项统计
  - 设置会话为非活动状态
```

#### 番茄钟流程
```
□ 工作时段结束自动进入休息
  - 显示系统通知
  - 判断休息类型（短休息/长休息）
  - 自动启动休息计时器

□ 休息结束提示继续
  - 显示"休息结束"模态框
  - 提供"继续工作"按钮
  - 点击后开始新的工作时段

□ 长休息逻辑正确
  - 完成 N 个番茄钟后进入长休息
  - N 根据配置确定（默认 4）
  - 长休息后重置计数
```

#### 跳过休息
```
□ 显示"跳过休息"按钮
  - 仅在休息时段显示

□ 点击后直接进入工作
  - 停止休息计时器
  - 开始新的工作时段
  - 会话数据正确记录
```

#### 会话统计
```
□ 本次会话统计正确
  - 已完成番茄钟数
  - 总专注时长

□ 今日统计正确
  - 今日总番茄钟数
  - 今日总专注时长
  - 会话次数
```

---

### 5.2 技术性验收

#### 数据库设计
```
□ focus_sessions 表设计正确
  - 包含配置快照字段
  - 外键约束正确
  - 索引创建合理

□ pomodoro_records 表设计正确
  - type 字段枚举正确
  - 记录完整性（开始/结束时间）
  - 关联会话和事项
```

#### 状态机实现
```
□ 状态定义清晰
  - idle, work, short_break, long_break

□ 状态转换正确
  - idle → work
  - work → short_break → work
  - work → long_break → work

□ 状态持久化
  - 应用关闭时保存当前状态
  - 重启后恢复状态（可选）
```

#### 配置快照
```
□ 会话创建时保存配置快照
  - work_duration
  - short_break_duration
  - long_break_duration
  - long_break_interval

□ 修改配置不影响当前会话
  - 仅影响新创建的会话
```

#### 内存管理
```
□ 无内存泄漏
  - 所有定时器正确清理
  - useEffect 依赖正确
  - 事件监听器移除

□ 状态更新正确
  - 不触发不必要的重渲染
  - 使用 React.memo（必要时）
```

---

### 5.3 用户体验验收

```
□ 流程流畅
  - 工作 → 休息转换自然
  - 通知及时准确
  - UI 响应快速

□ 提示清晰
  - 当前阶段明确
  - 剩余时间清晰
  - 操作按钮易懂

□ 数据可见
  - 本次会话进度
  - 今日总体进度
  - 统计信息准确
```

---

## 6. 红线检查

### 6.1 技术选型红线

```
☑️ 仅使用批准的依赖
  - 无新增生产依赖 ✓

☑️ 不使用 UI 组件库
  - 自定义 BreakEndModal ✓

☑️ 继续使用 Zustand
  - useSessionStore ✓
```

### 6.2 代码实践红线

```
☑️ 不使用 var
  - 仅使用 const / let ✓

☑️ 不直接操作 DOM
  - 使用 React 组件 ✓

☑️ 函数长度 < 50 行
  - 复杂逻辑拆分 ✓

☑️ 嵌套深度 < 4 层
  - 使用早返回 ✓
```

### 6.3 安全红线

```
☑️ SQL 注入防护
  - 使用参数化查询 ✓
  - 不拼接 SQL ✓

☑️ 数据验证
  - 会话数据验证 ✓
  - 配置快照验证 ✓
```

### 6.4 性能红线

```
☑️ 无内存泄漏
  - 定时器清理 ✓
  - 事件监听器移除 ✓

☑️ 不阻塞主线程
  - 无长时间同步操作 ✓
```

---

## 7. 规范检查

### 7.1 代码风格规范

```
☑️ 缩进和空格
  - 2 空格缩进 ✓
  - 操作符前后空格 ✓

☑️ 引号和分号
  - 单引号 ✓
  - 不使用分号 ✓

☑️ 命名规范
  - 文件：PascalCase.jsx / camelCase.js ✓
  - Store：useSessionStore.js ✓
  - 函数：动词开头 ✓
```

### 7.2 React 规范

```
☑️ 组件定义
  - 函数组件 ✓
  - Props 解构 ✓

☑️ Hooks 使用
  - 顶层调用 ✓
  - 依赖数组正确 ✓

☑️ 状态管理
  - 仅订阅需要的状态 ✓
  - 避免不必要的重渲染 ✓
```

### 7.3 注释规范

```
☑️ 复杂逻辑添加注释
  - 状态转换逻辑 ✓
  - 配置快照逻辑 ✓

☑️ 函数注释
  - 公共 API 添加 JSDoc ✓
```

---

## 8. 风险与应对

### 8.1 技术风险

#### 风险 1: 状态机逻辑复杂

**风险等级:** 🟡 中
**概率:** 中
**影响:** 高（影响核心功能）

**应对策略:**
1. **提前设计:** Day 2 仔细设计状态转换
2. **绘制状态图:** 可视化状态转换
3. **单元测试:** 测试状态转换逻辑
4. **代码审查:** 重点审查状态机代码

**应急计划:**
- 简化状态机，先实现基础流程
- 高级功能（如暂停恢复）延期到 Phase 3

---

#### 风险 2: 配置快照实现错误

**风险等级:** 🟡 中
**概率:** 低
**影响:** 中（数据不一致）

**应对策略:**
1. **Schema 设计清晰:** 明确快照字段
2. **充分测试:** 测试配置修改场景
3. **数据验证:** 保存前验证快照完整性

**应急计划:**
- 如果快照逻辑有问题，暂时禁用配置修改
- 修复后再开放

---

#### 风险 3: 内存泄漏

**风险等级:** 🟢 低
**概率:** 低
**影响:** 中（性能问题）

**应对策略:**
1. **规范清理:** 所有 useEffect 返回清理函数
2. **定期检查:** 使用开发工具检查内存
3. **代码审查:** 重点检查定时器使用

**应急计划:**
- 使用 React DevTools Profiler 定位问题
- 重构有问题的组件

---

### 8.2 进度风险

#### 风险 4: 任务延期

**风险等级:** 🟢 低
**概率:** 低
**影响:** 低（仅 1 周任务）

**应对策略:**
1. **基于 Phase 1 经验:** 时间估算更准确
2. **优先级管理:** P0 任务优先
3. **每日检查:** 及时发现延期

**应急计划:**
- P1 任务可延期到 Phase 3
- 必要时加班 1-2 天

---

## 9. 每日检查清单

### Day 1 检查清单
```
□ focus_sessions 表创建完成
□ pomodoro_records 表创建完成
□ 索引创建正确
□ 会话数据库操作实现完成
□ IPC API 暴露完成
□ 数据库操作测试通过
```

### Day 2 检查清单
```
□ 状态机设计完成
□ useSessionStore 实现完成
□ 状态转换逻辑正确
□ 与 useTimerStore 集成成功
```

### Day 3 检查清单
```
□ 休息类型判断正确
□ 自动进入休息功能正常
□ BreakEndModal 组件完成
□ 休息结束提示正常
```

### Day 4 检查清单
```
□ 会话统计功能实现
□ 今日统计功能实现
□ 跳过休息功能正常
□ 会话暂停/恢复功能正常（可选）
```

### Day 5 检查清单
```
□ 完整流程测试通过
□ 边界情况测试通过
□ 无内存泄漏
□ 代码审查通过
□ 会话流程文档完成
```

---

## 10. 阶段总结

### 10.1 预期成果

**完成时你将拥有：**
- ✅ 完整的会话生命周期管理
- ✅ 自动休息功能
- ✅ 长休息间隔逻辑
- ✅ 会话统计功能
- ✅ 跳过休息功能
- ✅ 配置快照机制

**技术债务（可接受）：**
- ⚠️ 无会话历史查看（Phase 3 实现）
- ⚠️ 无详细统计图表（Phase 3 实现）
- ⚠️ 会话暂停/恢复可能延期

### 10.2 下一阶段准备

**Phase 3 前提条件：**
- ✅ Phase 2 所有 P0 任务完成
- ✅ 通过 M2 验收
- ✅ 会话数据完整记录

**Phase 3 预习：**
- 📖 研究 Recharts 图表库
- 📖 设计统计页面布局
- 📖 准备统计算法

---

**文档状态:** ✅ 已完成
**前置条件:** 等待 Phase 1 完成
**最后更新:** 2025-11-29
**下次审查:** Phase 1 完成后

**等待 Phase 1 验收通过后开始！** 🚀
